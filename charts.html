<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta http-equiv="Content-Language" content="fr" />
  <link rel="shortcut icon" href="ressources/img/favicon.ico">
  <link rel="stylesheet" href="ressources/style.css" type="text/css" />
  <link rel="stylesheet" href="ressources/leaflet/leaflet.css">

  <title>UBPE2014@Valence | Charts</title>
</head>
<body>
  <div id="big-frame">
    <div id="frame">
      <div id="page">
        <div id="title">
          <div id="title-left">
            <h2>Charts</h2>
          </div>
        </div>
        <div id="page-content">
          <div id="graph"></div>
          <div id="button-holder-graphique">
            <ul>
              <li>X-axis: <select name="x" id="x"></select></li>
              <li>Y-axis: <select name="y" id="y"></select></li>
            </ul>
          </div>
        </div>
      </div>
      <!-- end page -->
    </div>
    <!-- end frame -->
  </div>

  <script type="text/javascript" src="ressources/js/jquery-1.9.0.min.js"></script>
  <script type="text/javascript" src="ressources/flot/jquery.flot.js"></script>
  <script type="text/javascript" src="ressources/flot/jquery.flot.time.js"></script>
  <script type="text/javascript" src="ressources/flot/jquery.flot.axislabels.js"></script>
  <script type="text/javascript" src="ressources/flot/jquery.flot.tooltip.js"></script>
  <script type="text/javascript" src="ressources/leaflet/leaflet.js"></script>
  <script type="text/javascript" src="ressources/js/moment.js"></script>

  <script type="text/javascript" src="ressources/js/settings.js"></script>
  <script type="text/javascript" src="ressources/js/blacklist.js"></script>
  <script type="text/javascript" src="data/events.clean" id="events-file"></script>
  <script type="text/javascript" src="ressources/js/common.js"></script>

  <script>
    (function initSelects() {
      var x = $('#x');
      for (var i in settings.chartXAxis) {
        var val = settings.chartXAxis[i];
        x.append('<option value="' + val + '">' + settings.fieldLabels[val] +  '</option>');
      }
      var y = $('#y');
      for (var i in settings.chartYAxis) {
        var val = settings.chartYAxis[i];
        y.append('<option value="' + val + '">' + settings.fieldLabels[val] +  '</option>');
      }
      x.find('option:first-child').attr('selected', 'selected');
      y.find('option:first-child').attr('selected', 'selected');

      $('#x, #y').bind('change', displayChart);
    })();

    var graph = $("#graph");

    var graph_options = {
      legend : {
        show : true,
        position : 'ne',
        backgroundColor : null,
        backgroundOpacity : 0
      },
      grid : {
        show : true,
        color : '#ff8c00',
        backgroundColor : null,
        hoverable : true,
        mouseActiveRadius : 30
      },
      tooltip: true,
      tooltipOpts: {
        content: "%lx = %x<br />%ly = %y",
        xDateFormat: "%H:%M:%S",
        yDateFormat: "%H:%M:%S",
      },
      xaxis : {color : 'orange'},
      yaxis : {color : 'orange'},
    };

    function displayChart() {
      var xFieldName = $("#x").val();
      var yFieldName = $("#y").val();
      var xLabel = settings.fieldLabels[xFieldName];
      var yLabel = settings.fieldLabels[yFieldName];

      // Handle the time.
      if (xFieldName == "timestamp") {
        graph_options["xaxis"]["mode"] = "time";
      } else {
        graph_options["xaxis"]["mode"] = "";
      }
      var xUnitString = "";
      if (settings.fieldUnits[xFieldName] != null) {
        xUnitString = " (" + settings.fieldUnits[xFieldName] + ")";
      }

      var yUnitString = "";
      if (settings.fieldUnits[yFieldName] != null) {
        yUnitString = " (" + settings.fieldUnits[yFieldName] + ")";
      }

      graph_options["xaxes"] = [{axisLabel: xLabel + xUnitString}];
      graph_options["yaxes"] = [{axisLabel: yLabel + yUnitString}];

      var tab = [];
      for (var i = 0; i < rawData.length; i++) {
        if (data[i]['fixGPS'] == "V" && (xFieldName == "altGPS" || yFieldName == "altGPS")) {  // Invalid GPS data, don't try to plot it.
          return;
        }
        tab.push([rawData[i][xFieldName], filteredData[i][yFieldName]]);
      }
      console.log(tab);

      var dTab = {
        data: tab,
        color: 'red',
        points: {show : true},
      }

      $.plot(graph, [dTab], graph_options);
    }

    handlePageUpdate();
  </script>
</body>
</html>
